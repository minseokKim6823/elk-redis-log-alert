input {
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # JSON 파싱
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # 타임스탬프 처리
  date {
    match => [ "timestamp", "ISO8601" ]
    target => "@timestamp"
  }
}

output {
  # 모든 로그를 Elasticsearch에 저장
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }

  # ERROR 레벨 로그는 Redis 큐에도 전송
  if [level] == "ERROR" {
    redis {
      host => "redis"
      port => 6379
      data_type => "list"
      key => "alert:queue"
      codec => json
    }
  }

  # 디버깅용 콘솔 출력
  stdout {
    codec => rubydebug
  }
}
